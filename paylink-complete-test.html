<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paylink Complete Test Tool</title>
  <style>
    /* Basic styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    h2, h3, h4 {
      color: #34495e;
    }
    
    /* Tab styles */
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
      border-radius: 5px 5px 0 0;
    }
    
    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      font-size: 16px;
    }
    
    .tab button:hover {
      background-color: #ddd;
    }
    
    .tab button.active {
      background-color: #3498db;
      color: white;
    }
    
    .tabcontent {
      display: none;
      padding: 20px;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 5px 5px;
      animation: fadeEffect 1s;
    }
    
    @keyframes fadeEffect {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    
    /* Form styles */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      margin-top: 6px;
      margin-bottom: 16px;
      resize: vertical;
      font-family: inherit;
    }
    
    button {
      background-color: #3498db;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #2980b9;
    }
    
    button.secondary {
      background-color: #2ecc71;
    }
    
    button.secondary:hover {
      background-color: #27ae60;
    }
    
    button.danger {
      background-color: #e74c3c;
    }
    
    button.danger:hover {
      background-color: #c0392b;
    }
    
    .hidden {
      display: none;
    }
    
    /* Card styles */
    .card {
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      margin-bottom: 20px;
      padding: 20px;
    }
    
    .section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    /* Form group */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .form-group > div {
      flex: 1 1 300px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .form-row label {
      flex: 1;
    }
    
    .form-row input,
    .form-row select {
      flex: 2;
    }
    
    /* Button group */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    /* Response styles */
    pre {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    pre.success {
      background-color: rgba(46, 204, 113, 0.1);
      border-color: #2ecc71;
    }
    
    pre.error {
      background-color: rgba(231, 76, 60, 0.1);
      border-color: #e74c3c;
    }
    
    /* Log styles */
    .log-container {
      background-color: #2c3e50;
      color: #ecf0f1;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      height: 300px;
      overflow-y: auto;
    }
    
    .log-entry {
      margin-bottom: 8px;
      padding: 5px;
      border-left: 4px solid #7f8c8d;
      font-family: monospace;
    }
    
    .log-entry span {
      color: #95a5a6;
      margin-right: 10px;
    }
    
    .log-entry.info {
      border-left-color: #3498db;
    }
    
    .log-entry.success {
      border-left-color: #2ecc71;
    }
    
    .log-entry.warning {
      border-left-color: #f39c12;
    }
    
    .log-entry.error {
      border-left-color: #e74c3c;
    }
    
    /* Invoice details styles */
    .invoice-details {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .detail-row {
      display: flex;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .detail-row:last-child {
      border-bottom: none;
    }
    
    .detail-row .label {
      font-weight: bold;
      flex: 1;
      color: #7f8c8d;
    }
    
    .detail-row .value {
      flex: 2;
    }
    
    .detail-row .value.paid {
      color: #27ae60;
      font-weight: bold;
    }
    
    .detail-row .value.pending {
      color: #f39c12;
      font-weight: bold;
    }
    
    .detail-row .value.failed {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .payment-errors-section {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    .payment-errors {
      background-color: rgba(231, 76, 60, 0.05);
      border-left: 4px solid #e74c3c;
      padding: 15px;
      border-radius: 0 5px 5px 0;
    }
    
    .error-item {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px dashed #ddd;
    }
    
    .error-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .error-message {
      color: #e74c3c;
      font-weight: bold;
      padding: 10px;
      background-color: rgba(231, 76, 60, 0.1);
      border-radius: 4px;
      margin-top: 10px;
    }
    
    .note {
      padding: 10px 15px;
      background-color: #f8f4e5;
      border-left: 4px solid #f39c12;
      margin: 15px 0;
      border-radius: 0 4px 4px 0;
      font-size: 0.95em;
      line-height: 1.4;
    }
    
    /* Responsive layout */
    @media screen and (max-width: 768px) {
      .form-group > div {
        flex: 1 1 100%;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .button-group button {
        width: 100%;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <h1>Paylink Complete Test Tool</h1>
  
  <!-- Tab navigation -->
  <div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'setup')">Setup & Authentication</button>
    <button class="tablinks" onclick="openTab(event, 'invoice')">Create Invoice</button>
    <button class="tablinks" onclick="openTab(event, 'paymentTesting')">Payment Testing</button>
    <button class="tablinks" onclick="openTab(event, 'callbackMonitor')">Monitor Callbacks</button>
    <button class="tablinks" onclick="openTab(event, 'transactionRecords')">View Transactions</button>
    <button class="tablinks" onclick="openTab(event, 'debugData')">Debug Data</button>
  </div>
  
  <!-- Setup & Auth Tab -->
  <div id="setup" class="tabcontent" style="display: block;">
    <h2>Step 1: Setup & Authentication</h2>
    <div class="card">
      <h3>Paylink API Configuration</h3>
      <div>
        <label for="apiId">API ID:</label>
        <input type="text" id="apiId" placeholder="Your Paylink API ID">
      </div>
      <div>
        <label for="secretKey">Secret Key:</label>
        <input type="password" id="secretKey" placeholder="Your Paylink Secret Key">
      </div>
      <div>
        <label for="baseUrl">Base URL:</label>
        <input type="text" id="baseUrl" value="https://restpilot.paylink.sa" placeholder="Paylink API Base URL">
      </div>
      <div>
        <label for="environment">Environment:</label>
        <select id="environment">
          <option value="sandbox" selected>Sandbox</option>
          <option value="production">Production</option>
        </select>
      </div>
      <button id="authenticate">Authenticate</button>
      <div id="authResult" class="hidden">
        <h3>Authentication Result:</h3>
        <pre id="authToken"></pre>
      </div>
    </div>
  </div>
  
  <!-- Invoice Creation Tab -->
  <div id="invoice" class="tabcontent">
    <h2>Step 2: Create Invoice</h2>
    <div class="card">
      <h3>Callback Configuration</h3>
      <div>
        <label for="callbackUrl">Callback URL (callBackUrl with capital B):</label>
        <input type="text" id="callbackUrl" placeholder="Your callback URL">
      </div>
      <div>
        <label for="threeDsCallbackUrl">3DS Callback URL (threeDsCallBackUrl):</label>
        <input type="text" id="threeDsCallbackUrl" placeholder="Your 3DS callback URL">
      </div>
    </div>
    
    <div class="card">
      <h3>Invoice Details</h3>
      <div>
        <label for="clientName">Client Name:</label>
        <input type="text" id="clientName" value="John Doe">
      </div>
      <div>
        <label for="clientEmail">Client Email:</label>
        <input type="email" id="clientEmail" value="test@example.com">
      </div>
      <div>
        <label for="clientMobile">Client Mobile:</label>
        <input type="text" id="clientMobile" value="966500000000">
      </div>
      <div>
        <label for="amount">Amount:</label>
        <input type="number" id="amount" value="10.00" step="0.01">
      </div>
      <div>
        <label for="currency">Currency (use 'currency', not 'currencyCode'):</label>
        <select id="currency">
          <option value="SAR" selected>SAR (Saudi Riyal)</option>
          <option value="USD">USD (US Dollar)</option>
        </select>
      </div>
      <div>
        <label for="productTitle">Product Title (use 'title', not 'name'):</label>
        <input type="text" id="productTitle" value="Test Product">
      </div>
      <div>
        <label for="productQty">Product Quantity (use 'qty', not 'quantity'):</label>
        <input type="number" id="productQty" value="1" min="1">
      </div>
      <div>
        <label for="productDescription">Product Description (required field):</label>
        <input type="text" id="productDescription" value="Test subscription product">
      </div>
      <div>
        <label for="orderNumber">Order Number (auto-generated if empty):</label>
        <input type="text" id="orderNumber" placeholder="Leave empty for auto-generated">
      </div>
      <div>
        <label for="invoicePayload">Full Invoice Payload (JSON):</label>
        <textarea id="invoicePayload" rows="10"></textarea>
      </div>
      <button id="updatePayload">Update Payload from Form</button>
      <button id="createInvoice">Create Invoice</button>
    </div>
    
    <div id="invoiceResult" class="hidden card">
      <h3>Invoice Creation Result:</h3>
      <pre id="invoiceResponse"></pre>
      <div id="paymentUrlSection" class="hidden">
        <h3>Payment URL:</h3>
        <a id="paymentUrl" href="#" target="_blank"></a>
        <p>Click the link above to test the payment flow.</p>
        <button id="openPaymentWindow" class="secondary">Open Payment Page in New Window</button>
      </div>
    </div>
  </div>

  <!-- Payment Testing Tab -->
  <div id="paymentTesting" class="tabcontent">
    <div class="section" id="noTransactionWarning">
      <p>No active transaction. Please create an invoice first.</p>
    </div>
    
    <div class="section hidden" id="paymentScenarios">
      <h3>Payment Testing</h3>
      <p>Current Transaction ID: <span id="currentTransactionId"></span></p>
      <p>Payment URL: <a href="#" id="currentPaymentUrl" target="_blank"></a></p>
      
      <div class="button-group">
        <button onclick="testPaymentScenario('success')">Test Successful Payment</button>
        <button onclick="testPaymentScenario('failed')">Test Failed Payment</button>
        <button onclick="testPaymentScenario('3ds')">Test 3DS Flow</button>
        <button onclick="getInvoiceDetails()">Get Invoice Details</button>
      </div>
      
      <!-- Invoice Details Section -->
      <div id="invoiceDetailsSection" class="section hidden">
        <h3>Invoice Details</h3>
        <div id="invoiceDetails"></div>
        <div id="invoiceDetailsError" class="error-message hidden"></div>
      </div>
      
      <div class="section hidden" id="testInstructions">
        <h4>Test Instructions</h4>
        <div id="scenarioInstructions"></div>
      </div>
      
      <div class="section">
        <h4>Payment Result</h4>
        <div id="paymentResult"></div>
      </div>
      
      <div class="section hidden" id="invoiceDetailsSection">
        <h4>Invoice Details</h4>
        <div id="invoiceDetails"></div>
        <div class="error-message hidden" id="invoiceDetailsError"></div>
      <div id="paymentResult">
        <p>No payment results yet. Complete a test payment to see results.</p>
      </div>
    </div>
  </div>
  
  <!-- Callbacks Monitoring Tab -->
  <div id="callbacks" class="tabcontent">
    <h2>Step 4: Monitor Callbacks</h2>
    
    <div class="card">
      <h3>Callback Monitoring</h3>
      <p>Monitor the callbacks received from Paylink:</p>
      
      <div>
        <button id="checkCallbacks" class="secondary">Check Recent Callbacks</button>
        <button id="clearCallbackLog" class="danger">Clear Log</button>
      </div>
      
      <h4>Callback Log:</h4>
      <div id="callbackLog" class="card">
        <p class="info">No callbacks received yet. Complete a payment flow to trigger callbacks.</p>
      </div>
    </div>
    
    <div class="card">
      <h3>3DS Callback Monitoring</h3>
      <p>Monitor 3DS authentication callbacks:</p>
      
      <div>
        <button id="check3dsCallbacks" class="secondary">Check Recent 3DS Callbacks</button>
        <button id="clear3dsCallbackLog" class="danger">Clear Log</button>
      </div>
      
      <h4>3DS Callback Log:</h4>
      <div id="threeDsCallbackLog" class="card">
        <p class="info">No 3DS callbacks received yet. Complete a 3DS authentication flow to trigger callbacks.</p>
      </div>
    </div>
  </div>
  
  <!-- Transactions Tab -->
  <div id="transactions" class="tabcontent">
    <h2>Step 5: Verify Transactions</h2>
    
    <div class="card">
      <h3>Transaction History</h3>
      <p>View and verify transaction updates in your database:</p>
      
      <div>
        <button id="checkTransactions" class="secondary">Check Recent Transactions</button>
        <button id="refreshTransactions" class="secondary">Refresh</button>
      </div>
      
      <h4>Transaction Records:</h4>
      <div id="transactionRecords" class="card">
        <p class="info">No transaction records loaded yet. Click 'Check Recent Transactions' to view.</p>
      </div>
    </div>
    
    <div class="card">
      <h3>Transaction Details</h3>
      <div id="transactionDetails">
        <p>Select a transaction from the list to view details.</p>
      </div>
    </div>
  </div>
  
  <!-- Debug Data Tab -->
  <div id="debugData" class="tabcontent">
    <h2>Debug & API Request Data</h2>
    
    <div class="card">
      <h3>API Request/Response Data</h3>
      <p>Copy this request data to help debug the Node.js script:</p>
      <pre id="requestData">No request data available. Create an invoice first.</pre>
      <button id="copyRequestData" class="secondary">Copy to Clipboard</button>
      <button id="saveRequestData" class="secondary">Save to File</button>
    </div>
    
    <div class="card">
      <h3>Node.js Integration</h3>
      <p>Use this data to improve your Node.js integration:</p>
      <button id="generateNodeCode" class="secondary">Generate Node.js Code</button>
      <div id="nodeCodeSection" class="hidden">
        <h4>Node.js Code:</h4>
        <pre id="nodeCode"></pre>
        <button id="copyNodeCode" class="secondary">Copy to Clipboard</button>
      </div>
    </div>
  </div>
<script>
  // Global state
  const state = {
    authenticated: false,
    token: null,
    currentTransaction: null,
    apiId: localStorage.getItem('paylinkApiId') || '',
    secretKey: localStorage.getItem('paylinkSecretKey') || '',
    baseUrl: localStorage.getItem('paylinkBaseUrl') || 'https://restpilot.paylink.sa',
    callbackUrl: localStorage.getItem('paylinkCallbackUrl') || '',
    threeDsCallbackUrl: localStorage.getItem('paylinkThreeDsCallbackUrl') || '',
    lastInvoicePayload: null,
    lastResponse: null,
    environment: localStorage.getItem('paylinkEnvironment') || 'sandbox'
  };

  // Tab switching functionality
  function openTab(evt, tabName) {
    // Hide all tabs
    const tabcontent = document.getElementsByClassName("tabcontent");
    for (let i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    // Remove active class from all tab buttons
    const tablinks = document.getElementsByClassName("tablinks");
    for (let i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab and add active class to the button
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
  }

  // Format JSON for display
  function formatJson(jsonObj) {
    return JSON.stringify(jsonObj, null, 2);
  }

  // Add log entry with timestamp
  function addLogEntry(logContainerId, message, type = 'info') {
    const logContainer = document.getElementById(logContainerId);
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    const timestamp = new Date().toISOString();
    logEntry.innerHTML = `<span>[${timestamp}]</span> ${message}`;
    
    // If first entry is the default message, clear it
    if (logContainer.firstChild && logContainer.firstChild.textContent.includes('No callbacks received yet')) {
      logContainer.innerHTML = '';
    }
    
    logContainer.prepend(logEntry);
  }

  // Authentication function
  async function authenticate() {
    const apiId = document.getElementById('apiId').value.trim();
    const secretKey = document.getElementById('secretKey').value.trim();
    const baseUrl = document.getElementById('baseUrl').value.trim();
    const environment = document.getElementById('environment').value;
    
    if (!apiId || !secretKey || !baseUrl) {
      alert('Please enter API ID, Secret Key, and Base URL');
      return;
    }
    
    // Save credentials to localStorage
    localStorage.setItem('paylinkApiId', apiId);
    localStorage.setItem('paylinkSecretKey', secretKey);
    localStorage.setItem('paylinkBaseUrl', baseUrl);
    localStorage.setItem('paylinkEnvironment', environment);
    
    // Update state
    state.apiId = apiId;
    state.secretKey = secretKey;
    state.baseUrl = baseUrl;
    state.environment = environment;
    
    try {
      const response = await fetch(`${baseUrl}/api/auth`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
          'Origin': window.location.origin,
          'Referer': window.location.href
        },
        body: JSON.stringify({
          apiId: apiId,
          secretKey: secretKey,
          persistToken: true
        })
      });
      
      const data = await response.json();
      
      if (data.id_token) {
        state.token = data.id_token;
        state.authenticated = true;
        
        const authResult = document.getElementById('authResult');
        authResult.classList.remove('hidden');
        
        const authToken = document.getElementById('authToken');
        authToken.textContent = `Authentication successful! Token: ${data.id_token.substring(0, 20)}...`;
        authToken.className = 'success';
        
        return true;
      } else {
        const authResult = document.getElementById('authResult');
        authResult.classList.remove('hidden');
        
        const authToken = document.getElementById('authToken');
        authToken.textContent = `Authentication failed: ${JSON.stringify(data)}`;
        authToken.className = 'error';
        
        state.authenticated = false;
        state.token = null;
        return false;
      }
    } catch (error) {
      const authResult = document.getElementById('authResult');
      authResult.classList.remove('hidden');
      
      const authToken = document.getElementById('authToken');
      authToken.textContent = `Error during authentication: ${error.message}`;
      authToken.className = 'error';
      
      state.authenticated = false;
      state.token = null;
      return false;
    }
  }

  // Update invoice payload from form
  function updateInvoicePayload() {
    const clientName = document.getElementById('clientName').value.trim() || "Test Client";
    const clientEmail = document.getElementById('clientEmail').value.trim() || "test@example.com";
    const clientMobile = document.getElementById('clientMobile').value.trim() || "0500000000";
    
    // Strictly validate amount - ensure it's a number and has a default
    let amount = parseFloat(document.getElementById('amount').value);
    if (isNaN(amount) || amount <= 0) {
      amount = 100; // Default value if invalid
      document.getElementById('amount').value = amount;
    }
    
    const currency = document.getElementById('currency').value || "SAR";
    const productTitle = document.getElementById('productTitle').value.trim() || "Test Product";
    
    // Ensure quantity is valid
    let productQty = parseInt(document.getElementById('productQty').value);
    if (isNaN(productQty) || productQty <= 0) {
      productQty = 1; // Default value if invalid
      document.getElementById('productQty').value = productQty;
    }
    
    const productDescription = document.getElementById('productDescription').value.trim() || "Test product description";
    const orderNumber = document.getElementById('orderNumber').value.trim() || `ORDER-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
    const callbackUrl = document.getElementById('callbackUrl').value.trim();
    const threeDsCallbackUrl = document.getElementById('threeDsCallbackUrl').value.trim();
    
    // Save callback URLs to localStorage
    localStorage.setItem('paylinkCallbackUrl', callbackUrl);
    localStorage.setItem('paylinkThreeDsCallbackUrl', threeDsCallbackUrl);
    
    // Update state
    state.callbackUrl = callbackUrl;
    state.threeDsCallbackUrl = threeDsCallbackUrl;
    
    // Create payload with EXACTLY the required fields from official docs
    const payload = {
      // Core required fields exactly as in documentation
      amount: amount,
      orderNumber: orderNumber,
      callBackUrl: callbackUrl,           // Capital B as per docs
      cancelUrl: callbackUrl,             // Required for cancellation flow
      clientName: clientName,
      clientEmail: clientEmail,
      clientMobile: clientMobile,
      currency: "SAR",                   // HARDCODING to SAR to avoid null value
      
      // CRITICAL: Set ALL fields that appear in the response to prevent null values
      displayCurrencyIso: "SAR",         // Ensure currency display is consistent
      displayPending: true,              // Required for pending status
      paymentMethodId: 2,                // 2 for credit cards
      smsMessage: "",                   // Empty string instead of null
      
      // IMPORTANT: The following parameters MUST be set correctly to avoid redirect errors
      cancelUrl: callbackUrl,           // Same as callBackUrl for consistency
      returnUrl: callbackUrl,           // Add this as Paylink may require it
      
      // Required parameters for 3DS flow
      threeDSecure: true,               // Enable 3DS authentication
      browserHeaderInfo: JSON.stringify({
        userAgent: navigator.userAgent,
        accept: "*/*",
        language: navigator.language
      }),
      
      // These must not be null in the initial request or they'll show null in response
      supportedCardBrands: [],           // Empty array instead of null
      metadata: "",                     // Empty string instead of null
      
      // Products array with required properties
      products: [
        {
          title: productTitle,             // Use 'title' not 'name'
          price: amount,
          qty: productQty,                // Use 'qty' not 'quantity'
          description: productDescription  // Required field
        }
      ],
      
      // 3DS callback URL (for 3D Secure)
      threeDsCallBackUrl: threeDsCallbackUrl,
      
      // Required settings with explicit values
      paymentMethodId: 2,                 // For credit card payment = credit card
      displayPending: true,               // Explicitly set to true
      smsMessage: "",                   // Empty string instead of null
    };
    
    // Validate payload to ensure no null values
    // These are the fields that must have non-null values
    if (!payload.currency) payload.currency = "SAR";
    if (!payload.clientName) payload.clientName = "Test Client";
    if (!payload.clientEmail) payload.clientEmail = "test@example.com";
    if (!payload.clientMobile) payload.clientMobile = "0500000000";
    if (!payload.displayPending && payload.displayPending !== false) payload.displayPending = true;
    
    // Update textarea
    document.getElementById('invoicePayload').value = formatJson(payload);
    return payload;
  }

  // Create invoice function
  async function createInvoice() {
    if (!state.authenticated || !state.token) {
      alert('Please authenticate first!');
      return;
    }
    
    let payload;
    try {
      // Get payload from textarea
      payload = JSON.parse(document.getElementById('invoicePayload').value);
    } catch (error) {
      // If JSON parsing fails, update from form
      payload = updateInvoicePayload();
    }
    
    // Double-check critical fields for sandbox testing
    if (!payload.callBackUrl || !payload.threeDsCallBackUrl) {
      alert('Callback URLs are required for sandbox testing');
      return;
    }
    
    // CRITICAL: Force all required fields to have specific values - never null
    // This will ensure the API response does not have null values
    payload = {
      ...payload,
      // Core fields with exact field names from Paylink documentation
      amount: payload.amount || 10,
      currency: "SAR", // Force SAR as required by Paylink
      clientName: payload.clientName || "Test Client",
      clientEmail: payload.clientEmail || "test@example.com",
      clientMobile: payload.clientMobile || "0500000000",
      orderNumber: payload.orderNumber || `ORDER-${Date.now()}-${Math.floor(Math.random() * 10000)}`,
      
      // These fields must NEVER be null or the API will return null values
      displayPending: true,
      paymentMethodId: 2, // Credit card
      displayCurrencyIso: "SAR", // Match currency
      smsMessage: "", // Empty string, not null
      note: "",
      
      // URLs with capital B as specified in Paylink docs
      callBackUrl: payload.callBackUrl, // Capital B exactly as required
      cancelUrl: payload.cancelUrl || payload.callBackUrl,
      threeDsCallBackUrl: payload.threeDsCallBackUrl, // Capital B exactly as required
      
      // Products array with exact field names required by Paylink
      products: [{
        title: payload.products[0].title || "Test Product", // 'title' not 'name'
        price: payload.products[0].price || payload.amount || 10,
        qty: payload.products[0].qty || 1, // 'qty' not 'quantity'
        description: payload.products[0].description || "Test product description" // Required field
      }]
    };
    
    // Save payload for debugging
    state.lastInvoicePayload = payload;
    
    try {
      // Show loading message
      const invoiceResult = document.getElementById('invoiceResult');
      invoiceResult.classList.remove('hidden');
      const invoiceResponse = document.getElementById('invoiceResponse');
      invoiceResponse.textContent = 'Creating invoice, please wait...';
      invoiceResponse.className = '';
      
      // Simplified headers to avoid CORS issues
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${state.token}`,
        'Accept': 'application/json'
      };
      
      console.log('Sending invoice payload:', payload);
      console.log('With headers:', headers);
      
      const response = await fetch(`${state.baseUrl}/api/addInvoice`, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
      
      // Log raw response for debugging
      console.log('Raw response status:', response.status);
      console.log('Response headers:', Object.fromEntries([...response.headers.entries()]));
      
      const data = await response.json();
      state.lastResponse = data;
      
      // Update invoice result section
      invoiceResponse.textContent = formatJson(data);
      
      if (data.transactionNo && data.url) {
        // Success - show payment URL
        invoiceResponse.className = 'success';
        
        const paymentUrlSection = document.getElementById('paymentUrlSection');
        paymentUrlSection.classList.remove('hidden');
        
        const paymentUrl = document.getElementById('paymentUrl');
        paymentUrl.href = data.url;
        paymentUrl.textContent = data.url;
        
        // Save transaction info for testing
        state.currentTransaction = {
          transactionId: data.transactionNo,
          paymentUrl: data.url,
          orderNumber: payload.orderNumber
        };
        
        // Update payment testing tab
        document.getElementById('currentTransactionId').textContent = data.transactionNo;
        document.getElementById('currentPaymentUrl').href = data.url;
        document.getElementById('currentPaymentUrl').textContent = data.url;
        
        document.getElementById('paymentScenarios').classList.remove('hidden');
        document.getElementById('noTransactionWarning').classList.add('hidden');
        
        // Log the success
        addLogEntry('transactionRecords', `Created invoice with Transaction ID: ${data.transactionNo}`, 'success');
        
        // Add note for payment testing
        addLogEntry('transactionRecords', `Important: Use a private/incognito window to test the payment to avoid cache issues`, 'info');
        
        return true;
      } else {
        // Error with response data
        invoiceResponse.className = 'error';
        if (data.statusCode || data.message || data.error) {
          addLogEntry('transactionRecords', `Invoice creation failed: ${data.message || data.error || 'Error ' + data.statusCode}`, 'error');
        }
        return false;
      }
    } catch (error) {
      const invoiceResult = document.getElementById('invoiceResult');
      invoiceResult.classList.remove('hidden');
      
      const invoiceResponse = document.getElementById('invoiceResponse');
      invoiceResponse.textContent = `Error creating invoice: ${error.message}`;
      invoiceResponse.className = 'error';
      
      // Log the error
      addLogEntry('transactionRecords', `Exception during invoice creation: ${error.message}`, 'error');
      
      return false;
    }
  }

  // Open payment window
  function openPaymentWindow() {
    if (state.currentTransaction && state.currentTransaction.paymentUrl) {
      window.open(state.currentTransaction.paymentUrl, '_blank');
    }
  }

  // Test payment scenarios
  function testPaymentScenario(scenario) {
    if (!state.currentTransaction || !state.currentTransaction.paymentUrl) {
      alert('No active transaction. Please create an invoice first.');
      return;
    }
    
    const scenarioInstructions = document.getElementById('scenarioInstructions');
    const testInstructions = document.getElementById('testInstructions');
    testInstructions.classList.remove('hidden');
    
    let instructions = '';
    switch (scenario) {
      case 'success':
        instructions = `
          <h4>Test Successful Payment</h4>
          <p>To test a successful payment, use the following test card (as per <a href="https://developer.paylink.sa/docs/test-cards" target="_blank">official Paylink documentation</a>):</p>
          <ul>
            <li><strong>Card Number:</strong> 4111 1111 1111 1111</li>
            <li><strong>Expiry:</strong> Any future date (e.g., 12/25)</li>
            <li><strong>CVV:</strong> Any 3 digits (e.g., 123)</li>
            <li><strong>Card Holder:</strong> Any name</li>
          </ul>
          <p class="note"><strong>Important:</strong> Use a private/incognito browser window to avoid caching issues.</p>
          <button onclick="window.open('${state.currentTransaction.paymentUrl}', '_blank')">Open Payment Page</button>
          <p class="note">After payment, you will be redirected to your callback URL (callBackUrl). Then use the "Get Invoice Details" button to verify the payment status.</p>
        `;
        break;
      case 'failed':
        instructions = `
          <h4>Test Failed Payment</h4>
          <p>To test a failed payment (error 451), use the following test card (as per <a href="https://developer.paylink.sa/docs/test-cards" target="_blank">official Paylink documentation</a>):</p>
          <ul>
            <li><strong>Card Number:</strong> 4000 0000 0000 0002</li>
            <li><strong>Expiry:</strong> Any future date (e.g., 12/25)</li>
            <li><strong>CVV:</strong> Any 3 digits (e.g., 123)</li>
            <li><strong>Card Holder:</strong> Any name</li>
          </ul>
          <p class="note"><strong>Important:</strong> Use a private/incognito browser window to avoid caching issues.</p>
          <button onclick="window.open('${state.currentTransaction.paymentUrl}', '_blank')">Open Payment Page</button>
          <p class="note">After payment attempt, you will be redirected to your callback URL (callBackUrl). Then use the "Get Invoice Details" button to verify the payment error code 451.</p>
        `;
        break;
      case '3ds':
        instructions = `
          <h4>Test 3DS Flow</h4>
          <p>To test a 3D Secure payment, use the following test card (as per <a href="https://developer.paylink.sa/docs/test-cards" target="_blank">official Paylink documentation</a>):</p>
          <ul>
            <li><strong>Card Number:</strong> 4000 0000 0000 3063</li>
            <li><strong>Expiry:</strong> Any future date (e.g., 12/25)</li>
            <li><strong>CVV:</strong> Any 3 digits (e.g., 123)</li>
            <li><strong>Card Holder:</strong> Any name</li>
          </ul>
          <p>This will redirect you to a 3DS authentication page.</p>
          <p><strong>For 3DS:</strong> Use any password/code to complete the authentication.</p>
          <p class="note"><strong>Important:</strong> Use a private/incognito browser window to avoid caching issues.</p>
          <button onclick="window.open('${state.currentTransaction.paymentUrl}', '_blank')">Open Payment Page</button>
          <p class="note">After 3DS authentication, you will be redirected to your threeDsCallBackUrl. Then use the "Get Invoice Details" button to verify the payment status.</p>
        `;
        break;
    }
    
    // Update payment result
    document.getElementById('paymentResult').innerHTML = `
      <p>Payment test initiated. Follow the instructions above and monitor the callbacks.</p>
      <p>Transaction ID: ${state.currentTransaction.transactionId}</p>
    `;
  }
  
  // Get Invoice Details function
  async function getInvoiceDetails() {
    if (!state.authenticated) {
      alert('Please authenticate first');
      return;
    }
    
    if (!state.currentTransaction || !state.currentTransaction.transactionId) {
      alert('No active transaction. Please create an invoice first.');
      return;
    }
    
    const transactionNo = state.currentTransaction.transactionId;
    const invoiceDetailsSection = document.getElementById('invoiceDetailsSection');
    const invoiceDetails = document.getElementById('invoiceDetails');
    const invoiceDetailsError = document.getElementById('invoiceDetailsError');
    
    // Show section and loading message
    invoiceDetailsSection.classList.remove('hidden');
    invoiceDetails.textContent = 'Loading invoice details...';
    invoiceDetailsError.classList.add('hidden');
    
    // Add a log entry to help users verify what's happening
    addLogEntry('transactionRecords', `Fetching invoice details for Transaction ID: ${transactionNo}`, 'info');
    
    try {
      // Make API request exactly as documented
      const response = await fetch(`${state.baseUrl}/api/getInvoice/${transactionNo}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${state.token}`,
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
      // Add response to state for debugging
      state.lastInvoiceDetails = data;
      
      // Display the result
      invoiceDetails.innerHTML = '';
      
      if (data.orderStatus) {
        // Get data from both root response and nested gatewayOrderRequest
        const gRequest = data.gatewayOrderRequest || {};
        const currency = data.currency || gRequest.currency || "SAR";
        const orderNumber = data.orderNumber || gRequest.orderNumber || 'N/A';
        const clientName = data.clientName || gRequest.clientName || 'N/A';
        const clientEmail = data.clientEmail || gRequest.clientEmail || 'N/A';
        const clientMobile = data.clientMobile || gRequest.clientMobile || 'N/A';
        
        // Create formatted display for invoice details
        const detailsHTML = `
          <div class="invoice-details">
            <h3>Invoice ${transactionNo}</h3>
            <div class="detail-row">
              <span class="label">Order Status:</span>
              <span class="value ${data.orderStatus.toLowerCase()}"><strong>${data.orderStatus}</strong></span>
            </div>
            <div class="detail-row">
              <span class="label">Amount:</span>
              <span class="value">${data.amount} ${currency}</span>
            </div>
            <div class="detail-row">
              <span class="label">Order Number:</span>
              <span class="value">${orderNumber}</span>
            </div>
            <div class="detail-row">
              <span class="label">Client:</span>
              <span class="value">${clientName}</span>
            </div>
            <div class="detail-row">
              <span class="label">Client Email:</span>
              <span class="value">${clientEmail}</span>
            </div>
            <div class="detail-row">
              <span class="label">Client Mobile:</span>
              <span class="value">${clientMobile}</span>
            </div>
            ${data.paidAmount ? `
              <div class="detail-row">
                <span class="label">Paid Amount:</span>
                <span class="value">${data.paidAmount} ${currency}</span>
              </div>` : ''}
          </div>
          <div class="payment-errors-section">
            ${data.paymentErrors && data.paymentErrors.length > 0 ? `
              <h4>Payment Errors:</h4>
              <div class="payment-errors">
                ${data.paymentErrors.map(error => `
                  <div class="error-item">
                    <div><strong>Error Code:</strong> ${error.errorCode}</div>
                    <div><strong>Title:</strong> ${error.errorTitle}</div>
                    <div><strong>Message:</strong> ${error.errorMessage}</div>
                    <div><strong>Time:</strong> ${error.errorTime}</div>
                  </div>
                `).join('')}
              </div>` : ''}
          </div>
          <div class="raw-response">
            <h4>Full Response:</h4>
            <div class="debug-info">
              <strong>Debug Info:</strong>
              <ul>
                <li>Currency: ${currency || 'Not found'}</li>
                <li>From Root: ${data.currency || 'Null'}</li>
                <li>From Gateway Request: ${data.gatewayOrderRequest?.currency || 'Null'}</li>
              </ul>
            </div>
            <pre>${formatJson(data)}</pre>
          </div>
        `;
        
        invoiceDetails.innerHTML = detailsHTML;
        
        // Log transaction status
        const statusMessage = `Invoice ${transactionNo} status: ${data.orderStatus}`;
        if (data.orderStatus === 'Paid') {
          addLogEntry('transactionRecords', statusMessage, 'success');
        } else if (data.orderStatus === 'Pending Payment') {
          addLogEntry('transactionRecords', statusMessage, 'info');
        } else {
          addLogEntry('transactionRecords', statusMessage, 'warning');
        }
        
        // Log payment errors if any
        if (data.paymentErrors && data.paymentErrors.length > 0) {
          data.paymentErrors.forEach(error => {
            addLogEntry('transactionRecords', `Payment Error: ${error.errorTitle} (${error.errorCode}) - ${error.errorMessage}`, 'error');
          });
        }
      } else {
        // Error response
        invoiceDetails.innerHTML = `<div class="error">Could not retrieve invoice details. Response: ${formatJson(data)}</div>`;
        addLogEntry('transactionRecords', `Failed to get invoice details: ${data.message || 'Unknown error'}`, 'error');
      }
    } catch (error) {
      // Display error
      invoiceDetailsError.textContent = `Error retrieving invoice details: ${error.message}`;
      invoiceDetailsError.classList.remove('hidden');
      addLogEntry('transactionRecords', `Exception during get invoice: ${error.message}`, 'error');
    }
  }

  // Set up event listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Load saved values
    document.getElementById('apiId').value = state.apiId;
    document.getElementById('secretKey').value = state.secretKey;
    document.getElementById('baseUrl').value = state.baseUrl;
    document.getElementById('environment').value = state.environment;
    document.getElementById('callbackUrl').value = state.callbackUrl;
    document.getElementById('threeDsCallbackUrl').value = state.threeDsCallbackUrl;
    
    // Initialize invoice payload
    updateInvoicePayload();
    
    // Setup event listeners
    document.getElementById('authenticate').addEventListener('click', authenticate);
    document.getElementById('updatePayload').addEventListener('click', updateInvoicePayload);
    document.getElementById('createInvoice').addEventListener('click', createInvoice);
    document.getElementById('openPaymentWindow').addEventListener('click', function() {
      if (state.currentTransaction && state.currentTransaction.paymentUrl) {
        window.open(state.currentTransaction.paymentUrl, '_blank');
      }
    });
    
    document.getElementById('checkCallbacks').addEventListener('click', function() {
      addLogEntry('callbackLog', 'Check your server logs for callback data');
    });
    document.getElementById('check3dsCallbacks').addEventListener('click', function() {
      addLogEntry('threeDsCallbackLog', 'Check your server logs for 3DS callback data');
    });
    document.getElementById('checkTransactions').addEventListener('click', function() {
      addLogEntry('transactionRecords', 'Check your database for transaction records');
    });
  });
</script>
</body>
</html>
